<?xml version="1.0" encoding="UTF-8"?>
<simulation xmds-version="2">
	<name>bec_transport</name>
	<author>Jamie Feiss</author>
	<description>
		BEC transport test
	</description>

	<features>
		<auto_vectorise />
		<benchmark />
		<fftw plan="patient" />
		<validation kind="run-time"/>
		<globals>
			<![CDATA[
				const real T = 3.0; // End time
				const real x_0 = 3.0; // Final position
			]]>
		</globals>
	</features>

  <!-- Number of trajectories (single processor) -->
  <!-- <driver name="multi-path" paths="10" /> -->

    <!-- Define dimensions -->
    <geometry>
        <propagation_dimension>t</propagation_dimension>
        <transverse_dimensions>
			<dimension name="x" lattice="64"  domain="(-10, 10)" />
        </transverse_dimensions>
    </geometry>

  	<!-- Initialisation wavefunction -->
	<vector name="wavefunction" type="complex" dimensions="x">
		<components>psi</components>
		<initialisation>
			<![CDATA[
				psi = (1.0 / pow(M_PI, 0.25)) * exp(-pow(x, 2) / 2.0); // ground state of HO
			]]>
		</initialisation>
	</vector>

  	<!-- Timing function -->
	<computed_vector name="timing_function" dimensions="" type="real">
		<components>lambda</components>
		<evaluation>
			<![CDATA[
				lambda = t / T;
			]]>
		</evaluation>
	</computed_vector>

  	<!-- Harmonic trap potential -->
	<vector name="potential" type="real" dimensions="x">
		<components>V</components>
		<initialisation>
			<dependencies>timing_function</dependencies>
			<![CDATA[
				V = pow(x - lambda * x, 2) / 2.0;
			]]>
		</initialisation>
	</vector>

	<sequence>
		<!-- Imaginary time to find ground state -->
		<integrate algorithm="RK4" interval="5.0e-3" steps="10000">
			<samples>0</samples>
			<operators>
				<integration_vectors>wavefunction</integration_vectors>
				<dependencies>potential</dependencies>
				<operator kind="ip" constant="yes" type="real" >
					<operator_names>Ltt</operator_names>
					<![CDATA[
						Ltt = -pow(kx, 2) / 2.0;
					]]>
				</operator>
				<![CDATA[
					dpsi_dt = Ltt[psi] - (V + mod2(psi)) * psi;
				]]>
			</operators>
		</integrate>
		
		<!-- GPE -->
		<integrate algorithm="ARK45" interval="T" tolerance="1e-8">
			<samples>100</samples>
			<operators>
				<integration_vectors>wavefunction</integration_vectors>
				<dependencies>potential</dependencies>
				<operator kind="ip" constant="yes" type="imaginary" >
					<operator_names>Ltt</operator_names>
					<![CDATA[
						Ltt = -i * pow(kx, 2) / 2.0;
					]]>
				</operator>
				<![CDATA[
					dpsi_dt = Ltt[psi] - i * (V + mod2(psi)) * psi;
				]]>
			</operators>
		</integrate>
	</sequence>

	<output>
		<sampling_group basis="x" initial_sample="no">
			<moments>psi_real psi_imag density </moments>
			<dependencies>wavefunction</dependencies>
			<![CDATA[
				psi_real = psi.Re();
				psi_imag = psi.Im();
				density = mod2(psi);
			]]>
		</sampling_group>
	</output>
</simulation>